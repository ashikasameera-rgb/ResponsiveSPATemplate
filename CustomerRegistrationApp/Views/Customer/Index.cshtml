@model IEnumerable<CustomerRegistrationApp.Models.Customer>

@{
    ViewData["Tttle"] = "Customer Regisration";
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" />  
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.7.1.min.js"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<div class="container mt-5">
    <h3>Customer Management </h3>
    <button class="btn btn-primary mb-3" id="btn-add">Add Customer </button>

    <!-- Simple Alert Message -->
    <div id="alertPlaceholder" class="mb-3"></div>

    <table class="table table-bordered" id="customerTable">
        <thead>
            <tr>
                <td>Name</td><td>Email</td><td>Phone</td><td>Address</td><td>Actions</td>
            </tr>
        </thead>
        <tbody>
            @foreach (var c in Model)
            {
                <tr id="row-@c.Id" data-id="@c.Id">
                    <td class="name">@c.Name </td>
                    <td class="email">@c.Email</td>
                    <td class="phone">@c.PhoneNumber</td>
                    <td class="address">@c.Address</td>
                    <td>
                        <button class="btn btn-warning btn-sm editBtn">Edit</button>
                        <button class="btn btn-danger btn-sm deleteBtn">Delete</button>
                    </td>
                </tr>
            }
        </tbody>

    </table>
</div>

<!--Creat Edit Modal -->
<div class="modal fade" id="customerModal" tabindex="-1">
    <div class="modal-dialog" >
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Modal title</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="customerId"  />
                <input type="text" id="name" class="form-control mb-2" placeholder="Name"/>
                <input type="text" id="email" class="form-control mb-2" placeholder="EMail"/>
                <input type="text" id="phone" class="form-control mb-2" placeholder="Phone"/>
                <input type="text" id="address" class="form-control mb-2" placeholder="Address" />
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveBtn">Save changes</button>
            </div>
        </div>
    </div>
</div>
<script>
    let modal=new bootstrap.Modal(document.getElementById("customerModal"));
    $("#btn-add").click(function(){
        $("#modal-title").text("Add Customer");
        $("#customerId").val('');
        $("#name,#email,#phone,#address").val('');
        modal.show();
    });

    $("#saveBtn").click(function(){
        
            let id=$('#customerId').val();
    
            let data={
                Id: id? parseInt(id):0,
                Name:$("#name").val(),
                Email:$("#email").val(),
                PhoneNumber:$("#phone").val(),
                Address:$("#address").val()
            };
    
            let url = id? '/Customer/Update'  :'/Customer/Create';

            $.ajax({
                url:url,
                type:'POST',
                contentType:'application/json',
                data:JSON.stringify(data),
                success:function(res){
                    if (res.success)
                    {
                        modal.hide();

                        if (id)
                        {
                            let row=$('#row-'+id);
                            row.find(".name").text(res.data.name);
                            row.find(".email").text(res.data.email);
                            row.find(".phone").text(res.data.phoneNumber);
                            row.find(".address").text(res.data.address);

                            $("#alertPlaceholder").text("Customer Updated Succesfully!")
                        }
                        else
                        {
                            $("#customerTable tbody").append(`
                                        <tr id="row-${res.data.id}" data-id="${res.data.id}">
                                        <td class="name">${res.data.name}</td>
                                        <td class="email">${res.data.email}</td>
                                        <td class="phone">${res.data.phoneNumber}</td>
                                        <td class="address">${res.data.address}</td>
                                        <td>
                                            <button  class="btn btn-sm btn-warning editBtn">Edit</button>
                                            <button  class="btn btn-sm btn-danger deleteBtn">Delete</button>
                                        </td>
                                        </tr>`);

                            $("#alertPlaceholder").text("Customer Added Succesfully!")
                        }
                    }
                    else
                    {
                        $("#alertPlaceholder").text("Error Saving Customer!");
                    }
                }

            });
    });

    $(document).on("click",".editBtn",function(){
        let row=$(this).closest("tr");
        $("#modal-title").text("Edit Customer");
        $("#customerId").val(row.data("id"));
        $("#name").val(row.find(".name").text());
        $("#email").val(row.find(".email").text());
        $("#phone").val(row.find(".phone").text());
        $("#address").val(row.find(".address").text());
        modal.show();
    });

    $(document).on("click",".deleteBtn",function(){
        let row=$(this).closest("tr");
        let id=row.data("id");

        if (!id)
        {
            alert("Invalid Customer Id");
            return;
        }

        if (confirm("Are you sure you want to delete this record? ")){
            $.ajax({

                url:'/Customer/Delete/'+id,
                type:'POST',
                success: function(res){
                    if (res.success){
                        row.remove();
                        $("#alertPlaceholder").html(`
                           <div class="alert alert-sucess alert-dismissible fade show" role="alert">
                            Customer Deleted Successfully!
                             <buton type="button" class="btn-close" data-bs-dismiss="alert" area-label="close"></button>
                           </div>  
                        `);         
                    }
                    else
                    {
                        $("#alertPlaceholder").html(`
                             <div class="alert alert-danger alert-dismissible fade show" role="alert" >
                               Error deleteing Customer!
                               <button  type="button" class="btn-close" data-bs-dismiss="alert" area-label="close"></button>                             
                             </div>
                        `);

                    }

                },
                error:function(){
                         $("#alertPlaceholder").html(`
                              <div class="alert alert-danger alert-dismissible fade show" role="alert">
                              Server error could not delete customer!
                              <button type="button" class="btn-close" data-bs-dismiss="alert" area-label="close"><button>          
                              </div>
                               `);
                }
            });
        }


    });


</script>